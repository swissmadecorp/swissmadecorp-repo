/* Tiny Permanent Pen plugin
 *
 * Copyright 2010-2018 Tiny Technologies Inc. All rights reserved.
 *
 * Version: 1.0.0-12
 */

!function(){"use strict";var n,i,e,t,r,o,a,m=function(e){var n=e,t=function(){return n};return{get:t,set:function(e){n=e},clone:function(){return m(t())}}},u=(n="function",function(e){return function(e){if(null===e)return"null";var n=typeof e;return"object"===n&&Array.prototype.isPrototypeOf(e)?"array":"object"===n&&String.prototype.isPrototypeOf(e)?"string":n}(e)===n}),f=Object.prototype.hasOwnProperty,c=(i=function(e,n){return n},function(){for(var e=new Array(arguments.length),n=0;n<e.length;n++)e[n]=arguments[n];if(0===e.length)throw new Error("Can't merge zero objects");for(var t={},r=0;r<e.length;r++){var o=e[r];for(var a in o)f.call(o,a)&&(t[a]=i(t[a],o[a]))}return t}),s=function(e){return function(){return e}},l=s(!1),p=s(!0),g=l,d=p,v=function(){return y},y=(o={fold:function(e,n){return e()},is:g,isSome:g,isNone:d,getOr:r=function(e){return e},getOrThunk:t=function(e){return e()},getOrDie:function(e){throw new Error(e||"error: getOrDie called on none.")},getOrNull:function(){return null},getOrUndefined:function(){},or:r,orThunk:t,map:v,ap:v,each:function(){},bind:v,flatten:v,exists:g,forall:d,filter:v,equals:e=function(e){return e.isNone()},equals_:e,toArray:function(){return[]},toString:s("none()")},Object.freeze&&Object.freeze(o),o),h=function(t){var e=function(){return t},n=function(){return o},r=function(e){return e(t)},o={fold:function(e,n){return n(t)},is:function(e){return t===e},isSome:d,isNone:g,getOr:e,getOrThunk:e,getOrDie:e,getOrNull:e,getOrUndefined:e,or:n,orThunk:n,map:function(e){return h(e(t))},ap:function(e){return e.fold(v,function(e){return h(e(t))})},each:function(e){e(t)},bind:r,flatten:e,exists:r,forall:r,filter:function(e){return e(t)?o:y},equals:function(e){return e.is(t)},equals_:function(e,n){return e.fold(g,function(e){return n(t,e)})},toArray:function(){return[t]},toString:function(){return"some("+t+")"}};return o},b={some:h,none:v,from:function(e){return null==e?y:h(e)}},P={fontname:"arial,helvetica,sans-serif",forecolor:"#E74C3C",fontsize:"12pt",hilitecolor:"",bold:!0,italic:!1,underline:!1,strikethrough:!1},k=function(e){return b.from(e.getParam("permanentpen_properties")).map(function(e){return c(P,e)}).getOr(P)},O=function(e){return e.getParam("font_formats","Andale Mono=andale mono,monospace;Arial=arial,helvetica,sans-serif;Arial Black=arial black,sans-serif;Book Antiqua=book antiqua,palatino,serif;Comic Sans MS=comic sans ms,sans-serif;Courier New=courier new,courier,monospace;Georgia=georgia,palatino,serif;Helvetica=helvetica,arial,sans-serif;Impact=impact,sans-serif;Symbol=symbol;Tahoma=tahoma,arial,helvetica,sans-serif;Terminal=terminal,monaco,monospace;Times New Roman=times new roman,times,serif;Trebuchet MS=trebuchet ms,geneva,sans-serif;Verdana=verdana,geneva,sans-serif;Webdings=webdings;Wingd0ings=wingdings,zapf dingbats","hash","string")},C=function(e){return e.getParam("fontsize_formats","8pt 10pt 12pt 14pt 18pt 24pt 36pt","string").split(/[, ]/)},x=void 0===(a=Array.prototype.indexOf)?function(e,n){return w(e,n)}:function(e,n){return a.call(e,n)},A=function(e,n){return-1<x(e,n)},S=function(e,n){for(var t=0,r=e.length;t<r;t++)n(e[t],t,e)},T=function(e,n){for(var t=0,r=e.length;t<r;t++)if(n(e[t],t,e))return b.some(t);return b.none()},w=function(e,n){for(var t=0,r=e.length;t<r;++t)if(e[t]===n)return t;return-1},M=(Array.prototype.slice,u(Array.from)&&Array.from,Object.keys),z=function(e,t){var r=[];return function(e,n){for(var t=M(e),r=0,o=t.length;r<o;r++){var a=t[r];n(e[a],a,e)}}(e,function(e,n){r.push(t(e,n))}),r},N=function(e){return function(e,n){for(var t=e.length,r=new Array(t),o=0;o<t;o++){var a=e[o];r[o]=n(a,o,e)}return r}(C(e),function(e){return{text:e,value:e}})},j=function(e){var n=N(e);return{type:"panel",items:[{type:"selectbox",name:"fontname",label:"Font",items:z(O(e),function(e,n){return{text:n,value:e}})},{type:"selectbox",name:"fontsize",label:"Size",items:n},{type:"label",label:"Styles",items:[{type:"bar",items:[{type:"checkbox",name:"bold",label:"Bold"},{type:"checkbox",name:"italic",label:"Italic"},{type:"checkbox",name:"strikethrough",label:"Strikethrough"},{type:"checkbox",name:"underline",label:"Underline"}]}]},{name:"forecolor",type:"colorinput",label:"Text color"},{name:"hilitecolor",type:"colorinput",label:"Background color"}]}},R=function(t,e,r,o){t.addCommand("mceConfigurePermanentPen",function(){var r,o;o=e,(r=t).windowManager.open({title:"Permanent Pen Properties",size:"normal",body:j(r),onSubmit:function(e){var n,t=e.getData();o.set(t),n=t,r.fire("PermanentPenProperties",{properties:n}),e.close()},buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0}],initialData:o.get()})}),t.addCommand("mceTogglePermanentPen",function(){var e,n=!r.get();e=n,t.fire("PermanentPenToggle",{state:e}),r.set(n),n?o.enterPermaPenMode():o.leavePermaPenMode()})},q=function(e,n,t){if(!T(n,function(e){return e===t}).isSome()){var r=(o=function(e,n){return e+'"'+n+'" '},a="TinyMCE PermanentPen permanentpen_properties."+e+': "'+t+'" not found. Possible values are: ',S(n,function(e){a=o(a,e)}),a);console.log(r)}var o,a},D=function(e){var n,t=k(e);q("fontsize",C(e),t.fontsize),q("fontname",(n=O(e),z(n,function(e){return e})),t.fontname)},_=function(e,n,t){if(e.insertContent(t),f=e,!function(e,n){for(var t=0,r=e.length;t<r;++t)if(!0!==n(e[t],t,e))return!1;return!0}(n,function(e){return f.formatter.match(e.formatName,e.values)})){var r=e.selection.getRng();r.setStart(r.startContainer,r.startOffset-t.length),e.formatter.remove("removeformat"),u=e,S(n,function(e){u.formatter.apply(e.formatName,e.values)}),o=e.selection,a=t.length,(i=o.getRng().cloneRange()).setEnd(i.startContainer,i.startOffset+a),i.setStart(i.startContainer,i.startOffset+a),o.setRng(i)}var o,a,i,u,f},B=function(e,n){return A(["bold","italic","underline","strikethrough"],n)&&e?b.some({formatName:n,values:{}}):A(["forecolor","hilitecolor","fontname","fontsize"],n)&&0<e.length?b.some({formatName:n,values:{value:e}}):b.none()},E=function(e,n,t,r){var o;!(o=t).ctrlKey&&!o.metaKey&&!/^[a-zA-Z0-9]{2,}$/.test(o.key)&&0<o.key.length&&(t.preventDefault(),e.undoManager.typing=!0,e.undoManager.ignore(function(){"Apply"===r?_(e,function(e){for(var n=[],t=function(e){n.push(e)},r=0;r<e.length;r++)e[r].each(t);return n}(z(n,B)),t.key):function(e,n){e.insertContent(n);var t=e.selection.getRng();t.setStart(t.startContainer,t.startOffset-n.length),e.formatter.remove("removeformat"),e.selection.collapse(!1)}(e,t.key)}))};return tinymce.PluginManager.add("permanentpen",function(e){D(e);var n,t,r,o,a,i,u,f,c=m(!1),s=m(k(e)),l=(n=e,t=s,r=function(e){E(n,t.get(),e,"Apply")},o=function(e){E(n,t.get(),e,"Remove")},a=function(){n.off("keypress",r),n.off("keypress",o)},{enterPermaPenMode:function(){a(),n.on("keypress",r)},leavePermaPenMode:function(){a(),n.once("keypress",o),n.once("nodechange",function(){n.off("keypress",o)})}});R(e,s,c,l),(i=e).ui.registry.addMenuItem("configurepermanentpen",{icon:"permanent-pen",text:"Permanent pen properties...",onAction:function(){return i.execCommand("mceConfigurePermanentPen")}}),i.ui.registry.addMenuItem("permanentpen",{icon:"permanent-pen",text:"Permanent pen",onAction:function(){return i.execCommand("mceTogglePermanentPen")}}),(u=e).ui.registry.addToggleButton("permanentpen",{icon:"permanent-pen",tooltip:"Permanent pen",onAction:function(){return u.execCommand("mceTogglePermanentPen")},onSetup:function(n){var e=function(e){n.setActive(e.state)};return u.on("PermanentPenToggle",e),function(){return u.off("PermanentPenToggle",e)}}}),f=c,e.ui.registry.addContextMenu("configurepermanentpen",{update:function(){return f.get()?["configurepermanentpen"]:[]}})}),function(){}}()();