<?php

namespace App\Jobs;

use Illuminate\Bus\Queueable;
use Illuminate\Queue\SerializesModels;
use Illuminate\Queue\InteractsWithQueue;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Foundation\Bus\Dispatchable;

class ImportToShopify implements ShouldQueue
{
    use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;

    /**
     * Create a new job instance.
     *
     * @return void
     */
    public function __construct()
    {
        //
    }

    /**
     * Execute the job.
     *
     * @return void
     */
    public function handle()
    {
        $products=Product::where('p_price3P','<>',0)
            ->where('group_id',0)
            ->whereIn('p_condition',[1,2,3])
            ->where('p_newprice','>', '10');

        $fp = fopen('public/uploads/shopify.txt', 'w');
        $headers = array(
            "Handler", //1
            "Title", //2
            "Body (HTML)", //3
            "Vendor", //4
            "Standardized Product Type",  //5
            "Custom Product Type", // 6
            "Tags", // 7
            "Option1 Name",  // 8
            "Option1 Value",  // 9
            "Option2 Name",  // 10
            "Option2 Value", // 11
            "Option3 Name",  // 12
            "Option3 Value", // 13
            "Variant SKU", // 14
            "Variant Grams", // 15
            "Variant Inventory Tracker", // 16
            "Variant Inventory Qty", // 17
            "Variant Inventory Policy", // 18
            "Variant Fulfillment Service", // 19
            "Variant Price", // 20
            "Variant Compare At Price", // 21
            "Variant Requires Shipping", // 22
            "Variant Taxable", // 23
            "Variant Barcode", // 24
            "Image Src", // 25
            "Image Position", // 26
            "Image Alt Text", // 27
            "Gift Card", // 28
            "SEO Title", // 29
            "SEO Description", // 30
            "Google Shopping / Google Product Category", // 31
            "Google Shopping / Gender", // 32
            "Google Shopping / Age Group", // 33 
            "Google Shopping / MPN", // 34
            "Google Shopping / AdWords Grouping", // 35
            "Google Shopping / AdWords Labels", // 36
            "Google Shopping / Condition", // 37
            "Google Shopping / Custom Product", // 38
            "Google Shopping / Custom Label 0", // 39
            "Google Shopping / Custom Label 1", // 40
            "Google Shopping / Custom Label 2", // 41
            "Google Shopping / Custom Label 3", // 42
            "Google Shopping / Custom Label 4", // 43
            "Variant Image", // 44
            "Variant Weight Unit", // 45
            "Variant Tax Code", // 46
            "Cost per item", // 47
            "Price / International", // 48
            "Compare At Price / International", // 49
            "Status" // 50
        );

        fputcsv($fp,$headers);

        foreach ($products as $product) {
            $img = $product->images->first;
            if ($img) {
                $webprice = ceil($product->p_newprice+($product->p_newprice*.029));
                $path = production().'images/'.$image->location;
                $instock = $product->p_qty > 0 ? 'in stock' : 'out of stock';
                $gender = Gender()->get($request['p_gender']);
                $material = Materials()->get($request['p_material']);

                $condition = strtolower(Conditions()->get($product->p_condition));
                if ($condition == 'unworn')
                    $condition = 'new';
                else $condition = 'used';

                if ($product->p_qty== 0)
                    $status = "archived";
                else $status = "active";

                fputcsv ($fp,
                        $product->id, // 1
                        $product->title, // 2
                        $product->title, // 3
                        $product->categories->first()->category_name, // 4
                        "Apparel & Accessories > Jewelry > Watches", // 5
                        "Watches", // 5
                        "", // 6
                        $product->keyword_build, // 7
                        "",
                        "",
                        "",
                        "",
                        "",
                        "", // 13
                        $product->p_reference, // 14
                        "",  // 15
                        "shopify", // 16
                        $product->qty, // 17
                        "deny", // 18
                        "manual", // 19
                        $webprice, // 20
                        "", // 21
                        TRUE, // 22
                        TRUE, // 23
                        "", // 24
                        $img, // 25
                        1, // 26
                        $product->title, // 27
                        FALSE, // 28
                        $product->title, // 29
                        $product->title, // 30
                        "Apparel & Accessories > Jewelry > Watches", // 31
                        $gender, // 32
                        "Adult", // 33
                        "", // 34
                        "", // 35
                        "", // 36
                        $condition, // 37
                        "", // 38
                        "", // 39
                        "", // 40
                        "", // 41
                        "", // 42
                        "", // 43
                        "", // 44
                        "", // 45
                        "", // 46
                        "", // 47
                        "", // 48
                        "", // 49
                        $status

            );
            }
        }

        fclose($fp);
    }
}
